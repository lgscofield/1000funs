<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" 
	"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<!--订单 -->
<mapper namespace="com.funs.order">

	<!-- 插入Order数据 -->
	<insert id="insertOrder" parameterType="com.funs.order.model.OrderVO">
		INSERT INTO
		orders(code,shop_id,create_time,except_time,user_id,user_remark,address,contact,phone,order_status,manager_id,manager_remark,sender_id,payment_type,total_price,deleted)
		VALUES
		(#{code},#{shopId},#{createTime},#{exceptTime},#{userId},#{userRemark},#{address},#{contact},#{phone},#{orderStatus},#{managerId},#{managerRemark},#{senderId},#{paymentType},#{totalPrice},false)
	</insert>

	<!-- 根据userId查询用户未评价的订单 order_status=1表示订单状态：已处理-->
	<select id="queryUnEvaluateOrder" parameterType="int"
		resultType="com.funs.order.model.OrderVO">
		SELECT * FROM orders o WHERE
		o.user_id=#{userId} AND o.order_status=0 AND o.deleted=false 
	</select>
	
	<select id="queryOrdersWithFood" parameterType="Map" resultType="com.funs.order.model.OrderVOWithFood">
		select o.*, i.id as food_id, i.amount as amount, f.food_name, f.image as food_image
		from order_item i, orders o, food f
		where i.deleted = false and o.deleted = false and f.deleted = false
		  and o.id = i.order_id and i.item_id = f.id
		  and i.item_type = #{itemType}  
		  and o.shop_id = #{shopId} and o.user_id = #{userId}
		  and o.order_status = #{orderStatus}
		  <if test="keyWord != null">
		  	and concat(o.address,o.contact,o.phone) like #{keyWord}
		  </if>
		order by o.id
	</select>

	<select id="queryOrdersWithFood_0" parameterType="Map" resultType="com.funs.order.model.OrderVOWithFood">
		select o.*, i.id as food_id, i.amount as amount, f.food_name, f.image as food_image
		from order_item i, orders o, food f
		where i.deleted = false and o.deleted = false and f.deleted = false
		  and o.id = i.order_id and i.item_id = f.id
		  and i.item_type = 0
		  and o.shop_id = 1 and o.user_id = 3
		  and o.order_status = 0
		  <if test="keyWord != null">
		  	and concat(o.address,o.contact,o.phone) like #{keyWord}
		  </if>
		order by o.id
	</select>
	
</mapper>